<!DOCTYPE html>
<html lang="sv" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>High Hand</title>
    
    <!-- 
      OPTIMIZATION: 
      The <link rel="preload"> tags have been removed to fix the browser warning.
      Images are now loaded on-demand by the JavaScript below. 
    -->

    <!-- This icon link assumes the file exists at this path. Update if necessary. -->
    <link rel="icon" href="/images/misc/logo.png" type="image/png">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <style>
        /* Basic CSS Reset */
        *, *::before, *::after { box-sizing: border-box; }
        html { line-height: 1.5; -webkit-text-size-adjust: 100%; font-family: sans-serif; }
        body { margin: 0; }
        
        /* Extracted Tailwind CSS Classes */
        .h-full { height: 100%; }
        .w-full { width: 100%; }
        .relative { position: relative; }
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .flex-shrink-0 { flex-shrink: 0; }
        .items-center { align-items: center; }
        .justify-center { justify-content: center; }
        .justify-between { justify-content: space-between; }
        .p-4 { padding: 1rem; }
        .my-2 { margin-top: 0.5rem; margin-bottom: 0.5rem; }
        .my-4 { margin-top: 1rem; margin-bottom: 1rem; }
        .gap-2 { gap: 0.5rem; }
        .text-center { text-align: center; }
        .text-white { color: rgba(255, 255, 255, 1); }
        .text-gray-300 { color: rgba(209, 213, 219, 1); }
        .text-gray-900 { color: rgba(17, 24, 39, 1); }
        .text-yellow-300 { color: rgba(253, 224, 71, 1); }
        .text-yellow-400 { color: rgba(250, 204, 21, 1); }
        .bg-black { background-color: rgba(0, 0, 0, 1); }
        .bg-opacity-50 { --tw-bg-opacity: 0.5; background-color: rgba(0, 0, 0, var(--tw-bg-opacity)); }
        .bg-yellow-400 { background-color: rgba(250, 204, 21, 1); }
        .rounded-full { border-radius: 9999px; }
        .font-bold { font-weight: 700; }
        .font-extrabold { font-weight: 800; }
        .uppercase { text-transform: uppercase; }
        .leading-none { line-height: 1; }
        .leading-tight { line-height: 1.25; }
        .tracking-wider { letter-spacing: 0.05em; }
        .tracking-wide { letter-spacing: 0.025em; }
        .text-2xl { font-size: 1.5rem; line-height: 2rem; }
        .text-\[min\(8vw\,6rem\)\] { font-size: min(8vw, 6rem); }
        .text-\[min\(10vw\,5rem\)\] { font-size: min(10vw, 5rem); }
        .text-\[2\.8rem\] { font-size: 2.8rem; }
        .hidden { display: none; }
        .w-20 { width: 5rem; }
        .h-20 { height: 5rem; }
        .min-h-\[4rem\] { min-height: 4rem; }
        .min-h-\[6rem\] { min-height: 6rem; }
        .w-\[18vw\] { width: 18vw; }
        .max-w-\[180px\] { max-width: 180px; }
        .aspect-\[2\.5\/3\.5\] { aspect-ratio: 2.5 / 3.5; }
        .object-contain { object-fit: contain; }
        .shadow-2xl { box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); }
        .drop-shadow-lg { filter: drop-shadow(0 10px 8px rgba(0,0,0,0.04)) drop-shadow(0 4px 3px rgba(0,0,0,0.1)); }
        .drop-shadow-xl { filter: drop-shadow(0 20px 13px rgba(0,0,0,0.03)) drop-shadow(0 8px 5px rgba(0,0,0,0.08)); }
        
        @keyframes pulse { 50% { opacity: .5; } }
        .animate-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        
        @media (min-width: 640px) {
            .sm\:p-8 { padding: 2rem; }
            .sm\:w-24 { width: 6rem; }
            .sm\:h-24 { height: 6rem; }
            .sm\:gap-4 { gap: 1rem; }
            .sm\:text-4xl { font-size: 2.25rem; line-height: 2.5rem; }
            .sm\:text-\[4rem\] { font-size: 4rem; }
            .sm\:min-h-\[8rem\] { min-height: 8rem; }
        }
        @media (min-width: 768px) {
            .md\:gap-6 { gap: 1.5rem; }
        }

        body {
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            transition: background-image 0.5s ease-in-out;
        }
    </style>
</head>
<body class="h-full text-white">

    <div id="app" class="relative w-full h-full flex flex-col justify-between text-center p-4 sm:p-8 bg-black bg-opacity-50">
        
        <div class="flex justify-between items-center">
            <div class="w-20 sm:w-24 flex-shrink-0"></div>
            <h1 class="font-bold tracking-wider uppercase text-yellow-400 text-[min(8vw,6rem)] leading-tight" style="text-shadow: 2px 2px 4px rgba(0,0,0,0.7);">
                KVÄLLENS HIGH HAND
            </h1>
            <div id="participant-circle-container" class="hidden flex-shrink-0">
                <div class="w-20 h-20 sm:w-24 sm:h-24 bg-yellow-400 text-gray-900 rounded-full flex items-center justify-center shadow-2xl">
                    <span id="participant-count" class="font-bold leading-none text-[2.8rem] sm:text-[4rem]"></span>
                </div>
            </div>
        </div>

        <div id="cards-and-handname" class="flex flex-col items-center justify-center my-4">
            <div id="cards-container" class="flex justify-center items-center gap-2 sm:gap-4 md:gap-6">
                <!-- Card images will be injected here by JavaScript -->
            </div>
        </div>

        <div id="handname-section" class="flex items-center justify-center my-2 min-h-[4rem]">
            <div id="hand-name" class="text-[min(10vw,5rem)] sm:text-[4rem] font-extrabold text-yellow-300 drop-shadow-lg uppercase tracking-wide"></div>
        </div>
        
        <div id="player-section" class="min-h-[6rem] sm:min-h-[8rem] flex items-center justify-center">
             <p id="status-text" class="text-2xl sm:text-4xl text-gray-300 animate-pulse">Ansluter till servern...</p>
             <h2 id="player-name" class="font-bold uppercase text-[min(8vw,6rem)] leading-none hidden"></h2>
        </div>

    </div>

    <script type="module">
        const playerNameEl = document.getElementById('player-name');
        const cardsContainerEl = document.getElementById('cards-container');
        const statusTextEl = document.getElementById('status-text');
        const participantCircleContainer = document.getElementById('participant-circle-container');
        const participantCountEl = document.getElementById('participant-count');
        const bodyEl = document.body;
        const handNameEl = document.getElementById('hand-name');
        let currentHandState = {};

        function getCardImageFilename(card) {
            if (card.rank === "N/A" || card.suit === "N/A") return "nn.png";
            const rankMap = { 'A': 'a', 'K': 'k', 'Q': 'q', 'J': 'j', '10': '10', '9': '9', '8': '8', '7': '7', '6': '6', '5': '5', '4': '4', '3': '3', '2': '2' };
            const suitMap = { '♠': 's', '♥': 'h', '♦': 'r', '♣': 'k' };
            const rank = rankMap[card.rank];
            const suit = suitMap[card.suit];
            if (rank && suit) { return `${rank}${suit}.png`; }
            return 'placeholder.png'; // A fallback image
        }

        function evaluateHand(cards) {
            if (cards.some(card => card.rank === "N/A" || card.suit === "N/A")) {
                return "100 KR FRIVILLIG SIDOPOTT";
            }
            const rankOrder = { 'A': 14, 'K': 13, 'Q': 12, 'J': 11, '10': 10, '9': 9, '8': 8, '7': 7, '6': 6, '5': 5, '4': 4, '3': 3, '2': 2 };
            const ranks = cards.map(c => c.rank);
            const suits = cards.map(c => c.suit);
            const values = ranks.map(r => rankOrder[r]).sort((a, b) => b - a);

            const rankCounts = {};
            ranks.forEach(r => rankCounts[r] = (rankCounts[r] || 0) + 1);
            const suitCounts = {};
            suits.forEach(s => suitCounts[s] = (suitCounts[s] || 0) + 1);

            const isFlush = Object.values(suitCounts).some(count => count === 5);
            const isStraight = (() => {
                const unique = [...new Set(values)];
                if (unique.length !== 5) return false;
                if (unique[0] - unique[4] === 4) return true;
                if (unique[0] === 14 && unique[1] === 5 && unique[2] === 4 && unique[3] === 3 && unique[4] === 2) return true;
                return false;
            })();

            const counts = Object.values(rankCounts).sort((a, b) => b - a);

            if (isFlush && isStraight && values[0] === 14) return "ROYAL FLUSH";
            if (isFlush && isStraight) return "FÄRGSTEGE";
            if (counts[0] === 4) return "FYRTAL";
            if (counts[0] === 3 && counts[1] === 2) return "KÅK";
            if (isFlush) return "FÄRG";
            if (isStraight) return "STEGE";
            if (counts[0] === 3) return "TRISS";
            if (counts[0] === 2 && counts[1] === 2) return "TVÅ PAR";
            if (counts[0] === 2) return "ETT PAR";
            return "HÖGT KORT";
        }

        function updateUI(data) {
            statusTextEl.classList.add('hidden');
            playerNameEl.classList.remove('hidden');
            
            // --- OPTIMIZATION ---
            // Load the new background image with JavaScript only when needed.
            // This fixes the preload warning and prevents a visual flicker.
            const imageName = data.backgroundImage; // e.g., 'room.jpg' or null
            const newBgUrl = imageName ? `${imageName}` : '';
            const newBgStyle = newBgUrl ? `url("${newBgUrl}")` : '';

            if (bodyEl.style.backgroundImage !== newBgStyle) {
                if (newBgUrl) {
                    const img = new Image();
                    img.onload = () => {
                        // Apply the image only after it has finished loading.
                        bodyEl.style.backgroundImage = newBgStyle;
                        document.documentElement.classList.remove('bg-gray-900');
                    };
                    img.src = newBgUrl;
                } else {
                    // If no image, clear the background.
                    bodyEl.style.backgroundImage = '';
                    document.documentElement.classList.add('bg-gray-900');
                }
            }

            if (
                data.cards && Array.isArray(data.cards) && data.cards.length === 5 &&
                data.cards.every(card => card.rank === "N/A" && card.suit === "N/A")
            ) {
                playerNameEl.textContent = "ANTAL ANMÄLDA";
            } else {
                playerNameEl.textContent = data.playerName || 'Okänd spelare';
            }

            participantCountEl.textContent = data.participantCount ?? 0;
            participantCircleContainer.classList.remove('hidden');

            if (data.cards && Array.isArray(data.cards)) {
                const newHandId = JSON.stringify(data.cards);
                if (currentHandState.id !== newHandId) {
                    currentHandState.id = newHandId;
                    cardsContainerEl.innerHTML = '';
                    data.cards.forEach(card => {
                        const filename = getCardImageFilename(card);
                        const cardHTML = `
                            <div class="w-[18vw] max-w-[180px] aspect-[2.5/3.5]">
                                <img src="/images/cards/${filename}" alt="${card.rank} ${card.suit}" class="w-full h-full object-contain drop-shadow-xl" loading="lazy">
                            </div>
                        `;
                        cardsContainerEl.insertAdjacentHTML('beforeend', cardHTML);
                    });
                }
                handNameEl.textContent = evaluateHand(data.cards);
            } else {
                handNameEl.textContent = '';
            }
        }
        
        function connect() {
            const protocol = window.location.protocol === 'https:' ? 'wss' : 'ws';
            const socket = new WebSocket(`${protocol}://${window.location.host}`);
            socket.onopen = () => { statusTextEl.textContent = 'Väntar på data...'; };
            socket.onmessage = (event) => { updateUI(JSON.parse(event.data)); };
            socket.onclose = () => {
                statusTextEl.textContent = 'Anslutning bruten. Försöker återansluta...';
                statusTextEl.classList.remove('hidden');
                playerNameEl.classList.add('hidden');
                participantCircleContainer.classList.add('hidden');
                setTimeout(connect, 3000);
            };
            socket.onerror = (error) => { console.error('WebSocket-fel:', error); socket.close(); };
        }

        connect();
    </script>
</body>
</html>
