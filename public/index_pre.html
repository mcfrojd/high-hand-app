<!DOCTYPE html>
<html lang="sv" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>High Hand</title>
    <link rel="icon" href="/images/misc/logo.png" type="image/png">
    <script src="https://cdn.tailwindcss.com"></script>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <style>
        body {
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            transition: background-image 0.5s ease-in-out;
        }
    </style>
</head>
<body class="h-full text-white">

    <div id="app" class="relative w-full h-full flex flex-col justify-between text-center p-4 sm:p-8 bg-black bg-opacity-50">
        
        <!-- Övre sektion: Titel & Cirkel -->
        <div class="flex justify-between items-center">
            <!-- Osynlig platshållare för att centrera titeln korrekt -->
            <div class="w-20 sm:w-24 flex-shrink-0"></div>

            <!-- Titel -->
            <h1 class="font-bold tracking-wider uppercase text-yellow-400 text-[min(8vw,6rem)] leading-tight" style="text-shadow: 2px 2px 4px rgba(0,0,0,0.7);">
                KVÄLLENS HIGH HAND
            </h1>

            <!-- Cirkel för antal deltagare -->
            <div id="participant-circle-container" class="hidden flex-shrink-0">
                <div class="w-20 h-20 sm:w-24 sm:h-24 bg-yellow-400 text-gray-900 rounded-full flex items-center justify-center shadow-2xl">
                    <span id="participant-count" class="font-bold leading-none text-[2.8rem] sm:text-[4rem]"></span>
                </div>
            </div>
        </div>

        <!-- Mellersta sektion: Korten -->
        <div id="cards-and-handname" class="flex flex-col items-center justify-center my-4">
            <div id="cards-container" class="flex justify-center items-center gap-2 sm:gap-4 md:gap-6">
                <!-- Kortbilder injiceras här -->
            </div>
        </div>

        <!-- Ny sektion: Handnamn -->
        <div id="handname-section" class="flex items-center justify-center my-2 min-h-[4rem]">
            <div id="hand-name" class="text-[min(10vw,5rem)] sm:text-[4rem] font-extrabold text-yellow-300 drop-shadow-lg uppercase tracking-wide"></div>
        </div>
        
        <!-- Nedre sektion: Spelarens namn -->
        <div id="player-section" class="min-h-[6rem] sm:min-h-[8rem] flex items-center justify-center">
             <p id="status-text" class="text-2xl sm:text-4xl text-gray-300 animate-pulse">Ansluter till servern...</p>
             <h2 id="player-name" class="font-bold uppercase text-[min(8vw,6rem)] leading-none hidden"></h2>
        </div>

    </div>


    <script type="module">
    const playerNameEl = document.getElementById('player-name');
    const cardsContainerEl = document.getElementById('cards-container');
    const statusTextEl = document.getElementById('status-text');
    const participantCircleContainer = document.getElementById('participant-circle-container');
    const participantCountEl = document.getElementById('participant-count');
    const bodyEl = document.body;
    const handNameEl = document.getElementById('hand-name');
    let currentHandState = {};

    function getCardImageFilename(card) {
        // Om kortet är "N/A" (reset-läge), visa nn.png
        if (card.rank === "N/A" || card.suit === "N/A") return "nn.png";
        const rankMap = { 'A': 'a', 'K': 'k', 'Q': 'q', 'J': 'j', '10': '10', '9': '9', '8': '8', '7': '7', '6': '6', '5': '5', '4': '4', '3': '3', '2': '2' };
        const suitMap = { '♠': 's', '♥': 'h', '♦': 'r', '♣': 'k' };
        const rank = rankMap[card.rank];
        const suit = suitMap[card.suit];
        if (rank && suit) { return `${rank}${suit}.png`; }
        return 'placeholder.png';
    }

    function evaluateHand(cards) {
        // Om något kort är "N/A", visa sidopott-texten
        if (cards.some(card => card.rank === "N/A" || card.suit === "N/A")) {
            return "100 KR FRIVILLIG SIDOPOTT";
        }
        const rankOrder = { 'A': 14, 'K': 13, 'Q': 12, 'J': 11, '10': 10, '9': 9, '8': 8, '7': 7, '6': 6, '5': 5, '4': 4, '3': 3, '2': 2 };
        const ranks = cards.map(c => c.rank);
        const suits = cards.map(c => c.suit);
        const values = ranks.map(r => rankOrder[r]).sort((a, b) => b - a);

        const rankCounts = {};
        ranks.forEach(r => rankCounts[r] = (rankCounts[r] || 0) + 1);
        const suitCounts = {};
        suits.forEach(s => suitCounts[s] = (suitCounts[s] || 0) + 1);

        const isFlush = Object.values(suitCounts).some(count => count === 5);
        const isStraight = (() => {
            const unique = [...new Set(values)];
            if (unique.length !== 5) return false;
            if (unique[0] - unique[4] === 4) return true;
            // Ess-låg stege
            if (unique[0] === 14 && unique[1] === 5 && unique[2] === 4 && unique[3] === 3 && unique[4] === 2) return true;
            return false;
        })();

        const counts = Object.values(rankCounts).sort((a, b) => b - a);

        if (isFlush && isStraight && values[0] === 14) return "ROYAL FLUSH";
        if (isFlush && isStraight) return "FÄRGSTEGE";
        if (counts[0] === 4) return "FYRTAL";
        if (counts[0] === 3 && counts[1] === 2) return "KÅK";
        if (isFlush) return "FÄRG";
        if (isStraight) return "STEGE";
        if (counts[0] === 3) return "TRISS";
        if (counts[0] === 2 && counts[1] === 2) return "TVÅ PAR";
        if (counts[0] === 2) return "ETT PAR";
        return "HÖGT KORT";
    }

    function updateUI(data) {
        statusTextEl.classList.add('hidden');
        playerNameEl.classList.remove('hidden');
        
        const newBg = data.backgroundImage ? `url('${data.backgroundImage}')` : '';
        if (bodyEl.style.backgroundImage !== newBg) {
            bodyEl.style.backgroundImage = newBg;
            document.documentElement.classList.toggle('bg-gray-900', !newBg);
        }

        // Om reset-läge: visa "ANTAL ANMÄLDA" istället för spelarnamn
        if (
            data.cards &&
            Array.isArray(data.cards) &&
            data.cards.length === 5 &&
            data.cards.every(card => card.rank === "N/A" && card.suit === "N/A")
        ) {
            playerNameEl.textContent = "ANTAL ANMÄLDA";
        } else {
            playerNameEl.textContent = data.playerName || 'Okänd spelare';
        }

        // Visa alltid deltagarcirkeln, även om det är 0
        participantCountEl.textContent = data.participantCount ?? 0;
        participantCircleContainer.classList.remove('hidden');

        if (data.cards && Array.isArray(data.cards)) {
            const newHandId = JSON.stringify(data.cards);
            if (currentHandState.id !== newHandId) {
                currentHandState.id = newHandId;
                cardsContainerEl.innerHTML = '';
                data.cards.forEach(card => {
                    const filename = getCardImageFilename(card);
                    const cardHTML = `
                        <div class="w-[18vw] max-w-[180px] aspect-[2.5/3.5]">
                            <img src="/images/cards/${filename}" alt="${card.rank} ${card.suit}" class="w-full h-full object-contain drop-shadow-xl">
                        </div>
                    `;
                    cardsContainerEl.insertAdjacentHTML('beforeend', cardHTML);
                });
            }
            // Visa handnamnet eller sidopott-texten
            handNameEl.textContent = evaluateHand(data.cards);
        } else {
            handNameEl.textContent = '';
        }
    }
    
    function connect() {
        const protocol = window.location.protocol === 'https:' ? 'wss' : 'ws';
        const socket = new WebSocket(`${protocol}://${window.location.host}`);
        socket.onopen = () => { statusTextEl.textContent = 'Väntar på data...'; };
        socket.onmessage = (event) => { updateUI(JSON.parse(event.data)); };
        socket.onclose = () => {
            statusTextEl.textContent = 'Anslutning bruten. Försöker återansluta...';
            statusTextEl.classList.remove('hidden');
            playerNameEl.classList.add('hidden');
            participantCircleContainer.classList.add('hidden');
            setTimeout(connect, 3000);
        };
        socket.onerror = (error) => { console.error('WebSocket-fel:', error); socket.close(); };
    }

    connect();
    </script>
</body>
</html>

